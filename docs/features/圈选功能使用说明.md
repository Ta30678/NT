# ETABS 梁編號工具 - 圈選功能使用說明

## 功能概述

已為 [index.html](index.html) 添加類似 AutoCAD 的圈選功能，可以方便地批量選擇和編輯梁編號。

## 使用方法

### 1. 框選梁

**Ctrl + 拖曳鼠標**：

- **從左到右拖曳**（藍色框）：只選擇完全在框內的梁（Window 模式）
- **從右到左拖曳**（綠色框）：選擇碰到框線的所有梁（Crossing 模式）

### 2. 單選/多選

- **Ctrl + 點擊梁或標籤**：切換該梁的選擇狀態
  - 未選中 → 選中
  - 已選中 → 取消選中

### 3. 取消選擇

- **Shift + 點擊已選中的梁**：從選中集合中移除該梁
- **Esc 鍵**：清除所有選擇

### 4. 批量編輯

選中多個梁後，有兩種方式打開批量編輯對話框：

- **按 Enter 鍵**
- 對話框會顯示選中梁的數量
- 輸入新編號（例如：g1, b1, fb2）
- 點擊「確定修改」即可將所有選中的梁改為相同編號

### 5. 視覺反饋

- **選中的梁**：顯示為黃色高亮，帶發光效果
- **選中的標籤**：字體加粗，顏色變深
- **圈選框**：
  - 藍色虛線框 = Window 模式（左→右）
  - 綠色虛線框 = Crossing 模式（右→左）

## 快捷鍵總覽

| 快捷鍵 | 功能 |
|--------|------|
| Ctrl + 拖曳 | 框選梁 |
| Ctrl + 點擊 | 單選/取消單個梁 |
| Shift + 點擊 | 從選中集合中移除 |
| Enter | 批量編輯選中梁的編號 |
| Esc | 清除所有選擇 |
| Delete | 清除選中梁的自定義編號（恢復原始編號） |

## 技術實現細節

### 新增的功能組件

1. **圈選邏輯**
   - Window 模式：檢查梁的兩端點是否完全在矩形內
   - Crossing 模式：使用線段相交算法檢查梁是否碰到矩形

2. **批量編輯對話框**
   - 位置：`#batch-edit-dialog`
   - 樣式：模態對話框，固定在屏幕中央
   - 功能：批量修改多個梁的編號

3. **CSS 樣式**
   - `.selection-rect`：藍色選擇框（Window 模式）
   - `.selection-rect-crossing`：綠色選擇框（Crossing 模式）
   - `.beam-selected`：選中梁的高亮樣式
   - `.beam-label-selected`：選中標籤的高亮樣式

4. **狀態管理**
   - `selectedBeams`：Set 對象，存儲所有選中梁的名稱
   - `isSelecting`：布爾值，標記是否正在框選
   - `selectionRect`：SVG 矩形元素，即時顯示選擇框

### 與現有功能的整合

- **與 svg-pan-zoom 的協調**：
  - 只有按住 Ctrl/Shift 時才啟用圈選
  - 框選時臨時禁用平移功能
  - 框選結束後重新啟用平移

- **與原有編輯功能的關係**：
  - 保留了 `openBeamEditDialog()` 函數供其他地方使用
  - 移除了梁線和標籤上的 click 事件監聽器
  - 改由統一的圈選系統處理點擊交互

## 測試建議

1. 上傳測試檔案：`2025-0916_WooGooWang227_Twin 2F.e2k`
2. 點擊「執行編號」生成梁編號
3. 測試各種圈選模式：
   - 從左到右框選（藍色）
   - 從右到左框選（綠色）
   - Ctrl + 點擊單選
   - Shift + 點擊取消選擇
4. 按 Enter 打開批量編輯對話框
5. 修改編號並確認效果

## 已知限制

1. 圈選功能需要在執行編號後才能使用（需要先有 SVG 圖形）
2. 切換樓層或重新執行編號會清除所有選擇
3. 批量編輯會將所有選中梁改為相同編號（不支持遞增編號）

## 未來可能的增強

- [ ] 支持批量遞增編號（如 g1, g2, g3...）
- [ ] 添加「全選」、「反選」功能
- [ ] 支持保存選擇集合
- [ ] 添加撤銷/重做功能
- [ ] 支持按條件篩選選擇（如按樓層、按斷面尺寸）
